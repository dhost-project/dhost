from django.db import models
from django.utils.translation import gettext_lazy as _

from dhost.dapps.models import AbstractDeployment, Dapp


class IPFSDapp(Dapp):
    """Dapp raidy to be deployed to the IPFS network"""

    hash = models.CharField(_('IPFS hash'), max_length=128, blank=True)

    class Meta(Dapp.Meta):
        verbose_name = _('IPFS Dapp')
        verbose_name_plural = _('IPFS Dapps')

    def deploy(self, bundle=None):
        """Create an `IPFSDeployment` object and start the deployment process
        from the bundled files
        """
        if bundle is None and len(self.bundles.all()) > 0:
            bundle = self.bundles.all()[0]
        print('='*20, '\n'  + self.bundles.all())

        deployment = IPFSDeployment(
            dapp=self,
            bundle=bundle,
        )
        deployment.save()
        is_success = deployment.deploy()
        return is_success

    def _get_url(self):
        """Generate URL based on hash and IPFS gateway"""
        pass


class IPFSDeployment(AbstractDeployment):
    hash = models.CharField(_('IPFS hash'), max_length=128, blank=True)

    class Meta(AbstractDeployment.Meta):
        verbose_name = _('IPFS Deployment')
        verbose_name_plural = _('IPFS Deployments')

    def delete(self, *args, **kwargs):
        # TODO remove from IPFS
        super().delete(*args, **kwargs)

    def deploy(self):
        # TODO
        return True
